# è‚¡ç¥¨å’¨è¯¢Agent - è‡ªåŒ…å«ç‰ˆæœ¬
# 
# ç‰¹ç‚¹ï¼š
# - æ— éœ€æœ¬åœ°æ–‡ä»¶ï¼Œä»Gitä»“åº“å…‹éš†
# - åªéœ€è¦è¿™ä¸ªDockerfileå°±èƒ½åœ¨ä»»ä½•åœ°æ–¹æ„å»º
# - é€‚åˆå¿«é€Ÿåˆ†å‘å’Œéƒ¨ç½²
#
# ä½¿ç”¨å‰æï¼š
# - ä»£ç å·²æ¨é€åˆ°Gitä»“åº“ï¼ˆGitHub/GitLab/Giteeç­‰ï¼‰
# 
# æ„å»ºç¤ºä¾‹ï¼š
#   docker build -f Dockerfile.standalone --build-arg MODE=mock --build-arg GIT_REPO=https://github.com/yourname/stock-agent.git -t stock-agent:mock .
#   docker build -f Dockerfile.standalone --build-arg MODE=gpu --build-arg GIT_REPO=https://github.com/yourname/stock-agent.git -t stock-agent:chatglm3 .

# ==================== æ„å»ºå‚æ•° ====================
ARG MODE=mock
ARG GIT_REPO=https://github.com/yourname/stock-agent.git
ARG GIT_BRANCH=main

# ==================== ç¬¬ä¸€é˜¶æ®µï¼šé€‰æ‹©åŸºç¡€é•œåƒ ====================
FROM python:3.11-slim as base-mock
FROM nvidia/cuda:11.8.0-runtime-ubuntu22.04 as base-gpu

# ==================== ç¬¬äºŒé˜¶æ®µï¼šæ ¹æ®æ¨¡å¼é€‰æ‹©åŸºç¡€é•œåƒ ====================
FROM base-${MODE} as builder
ARG MODE=mock
ARG GIT_REPO
ARG GIT_BRANCH

# å®‰è£…åŸºç¡€å·¥å…·ï¼ˆåŒ…æ‹¬gitï¼‰
RUN echo "============================================================" && \
    echo "ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–..." && \
    echo "============================================================" && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        wget \
        git \
        && rm -rf /var/lib/apt/lists/* && \
    echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ä»Gitå…‹éš†ä»£ç 
RUN echo "============================================================" && \
    echo "ğŸ“¥ ä»Gitä»“åº“å…‹éš†ä»£ç ..." && \
    echo "============================================================" && \
    echo "ä»“åº“: ${GIT_REPO}" && \
    echo "åˆ†æ”¯: ${GIT_BRANCH}" && \
    git clone -b ${GIT_BRANCH} ${GIT_REPO} . && \
    echo "âœ… ä»£ç å…‹éš†å®Œæˆ"

# å®‰è£…Pythonä¾èµ–
RUN echo "============================================================" && \
    echo "ğŸ“š å®‰è£…Pythonä¾èµ– (MODE=${MODE})..." && \
    echo "============================================================" && \
    if [ "${MODE}" = "mock" ]; then \
        echo "  â†’ Mockæ¨¡å¼ï¼šå®‰è£…è½»é‡çº§ä¾èµ–" && \
        pip install --no-cache-dir \
            fastapi==0.109.0 \
            uvicorn==0.27.0 \
            pydantic==2.12.5 \
            pyyaml==6.0.3 \
            pandas==2.2.0 \
            pyarrow==15.0.0 \
            requests==2.32.5 \
            langchain==1.2.6 \
            langchain-core==1.2.7 \
            -i https://pypi.tuna.tsinghua.edu.cn/simple && \
        echo "âœ… Mockæ¨¡å¼ä¾èµ–å®‰è£…å®Œæˆ"; \
    else \
        echo "  â†’ GPUæ¨¡å¼ï¼šå®‰è£…å®Œæ•´ä¾èµ–ï¼ˆåŒ…æ‹¬PyTorchï¼‰" && \
        pip install --no-cache-dir \
            torch==2.1.0 \
            transformers==4.36.0 \
            accelerate==0.25.0 \
            -i https://pypi.tuna.tsinghua.edu.cn/simple && \
        pip install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple && \
        echo "âœ… GPUæ¨¡å¼ä¾èµ–å®‰è£…å®Œæˆ"; \
    fi

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p models logs && \
    echo "âœ… ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"

# ==================== æœ€ç»ˆé˜¶æ®µ ====================
FROM base-${MODE} as final
ARG MODE=mock

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && \
    apt-get install -y --no-install-recommends curl && \
    rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ä»builderé˜¶æ®µå¤åˆ¶æ‰€æœ‰æ–‡ä»¶
COPY --from=builder /app /app
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# æš´éœ²ç«¯å£
EXPOSE 8765

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1
ENV MODE=${MODE}

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8765/health || exit 1

# å¯åŠ¨è„šæœ¬
RUN echo "============================================================" && \
    echo "ğŸ‰ é•œåƒæ„å»ºå®Œæˆï¼" && \
    echo "============================================================" && \
    echo "æ¨¡å¼: ${MODE}" && \
    echo "ç«¯å£: 8765" && \
    echo "============================================================"

# å¯åŠ¨å‘½ä»¤
CMD echo "============================================================" && \
    echo "ğŸš€ å¯åŠ¨è‚¡ç¥¨å’¨è¯¢AgentæœåŠ¡..." && \
    echo "============================================================" && \
    echo "æ¨¡å¼: $MODE" && \
    echo "ç«¯å£: 8765" && \
    echo "æ—¶é—´: $(date)" && \
    echo "============================================================" && \
    python start_server.py
